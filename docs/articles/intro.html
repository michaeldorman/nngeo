<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to package `nngeo` • nngeo</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to package `nngeo`">
<meta property="og:description" content="nngeo">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nngeo</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction to package `nngeo`</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/michaeldorman/nngeo/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to package <code>nngeo</code>
</h1>
                        <h4 class="author">Michael Dorman</h4>
            
            <h4 class="date">2021-06-13</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/michaeldorman/nngeo/blob/master/vignettes/intro.Rmd"><code>vignettes/intro.Rmd</code></a></small>
      <div class="hidden name"><code>intro.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<div id="package-purpose" class="section level2">
<h2 class="hasAnchor">
<a href="#package-purpose" class="anchor"></a>Package purpose</h2>
<p>This document introduces the <code>nngeo</code> package. The <code>nngeo</code> package includes functions for spatial join of layers based on <em>k-nearest neighbor</em> relation between features. The functions work with spatial layer object defined in package <code>sf</code>, namely classes <code>sfc</code> and <code>sf</code>.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>CRAN version:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"michaeldorman/nngeo"</span><span class="op">)</span></code></pre></div>
<p>GitHub version:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"nngeo"</span><span class="op">)</span></code></pre></div>
</div>
<div id="sample-data" class="section level2">
<h2 class="hasAnchor">
<a href="#sample-data" class="anchor"></a>Sample data</h2>
<p>The <code>nngeo</code> package comes with three sample datasets:</p>
<ul>
<li><code>cities</code></li>
<li><code>towns</code></li>
<li><code>water</code></li>
</ul>
<p>The <code>cities</code> layer is a <strong>point</strong> layer representing the location of the three largest cities in Israel.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cities</span>
<span class="co">#&gt; Simple feature collection with 3 features and 1 field</span>
<span class="co">#&gt; Geometry type: POINT</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 34.78177 ymin: 31.76832 xmax: 35.21371 ymax: 32.79405</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt;        name                  geometry</span>
<span class="co">#&gt; 1 Jerusalem POINT (35.21371 31.76832)</span>
<span class="co">#&gt; 2  Tel-Aviv  POINT (34.78177 32.0853)</span>
<span class="co">#&gt; 3     Haifa POINT (34.98957 32.79405)</span></code></pre></div>
<p>The <code>towns</code> layer is another <strong>point</strong> layer, with the location of all large towns in Israel, compiled from a different data source:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">towns</span>
<span class="co">#&gt; Simple feature collection with 193 features and 4 fields</span>
<span class="co">#&gt; Geometry type: POINT</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 34.27 ymin: 29.56 xmax: 35.6 ymax: 33.21</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;             name country.etc   pop capital            geometry</span>
<span class="co">#&gt; 12        'Afula      Israel 39151       0 POINT (35.29 32.62)</span>
<span class="co">#&gt; 17         'Akko      Israel 45606       0 POINT (35.08 32.94)</span>
<span class="co">#&gt; 40       'Ar'ara      Israel 15841       0  POINT (35.1 32.49)</span>
<span class="co">#&gt; 41         'Arad      Israel 22757       0 POINT (35.22 31.26)</span>
<span class="co">#&gt; 43       'Arrabe      Israel 20316       0 POINT (35.33 32.85)</span>
<span class="co">#&gt; 52        'Atlit      Israel  4686       0 POINT (34.93 32.68)</span>
<span class="co">#&gt; 103     'Eilabun      Israel  4296       0  POINT (35.4 32.83)</span>
<span class="co">#&gt; 104   'Ein Mahel      Israel 11014       0 POINT (35.35 32.72)</span>
<span class="co">#&gt; 105 'Ein Qiniyye      Israel  2101       0 POINT (35.15 31.93)</span>
<span class="co">#&gt; 112        'Ilut      Israel  6536       0 POINT (35.25 32.72)</span></code></pre></div>
<p>The <code>water</code> layer is an example of a <strong>polygonal</strong> layer. This layer contains four polygons of water bodies in Israel.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">water</span>
<span class="co">#&gt; Simple feature collection with 4 features and 1 field</span>
<span class="co">#&gt; Geometry type: POLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 34.1388 ymin: 29.45338 xmax: 35.64979 ymax: 33.1164</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt;                name                       geometry</span>
<span class="co">#&gt; 1           Red Sea POLYGON ((34.96428 29.54775...</span>
<span class="co">#&gt; 2 Mediterranean Sea POLYGON ((35.10533 33.07661...</span>
<span class="co">#&gt; 3          Dead Sea POLYGON ((35.54743 31.37881...</span>
<span class="co">#&gt; 4    Sea of Galilee POLYGON ((35.6014 32.89248,...</span></code></pre></div>
<p>Figure  shows the spatial configuration of the <code>cities</code>, <code>towns</code> and <code>water</code> layers.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">water</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">towns</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"grey"</span>, pch <span class="op">=</span> <span class="fl">1</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">cities</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">1</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="intro_files/figure-html/layers-1.png" alt="Visualization of the \texttt{water}, \texttt{towns} and \texttt{cities} layers" width="50%"><p class="caption">
Visualization of the ,  and  layers
</p>
</div>
</div>
</div>
<div id="usage-examples" class="section level1">
<h1 class="hasAnchor">
<a href="#usage-examples" class="anchor"></a>Usage examples</h1>
<div id="the-st_nn-function" class="section level2">
<h2 class="hasAnchor">
<a href="#the-st_nn-function" class="anchor"></a>The <code>st_nn</code> function</h2>
<p>The main function in the <code>nngeo</code> package is <code>st_nn</code>. The <code>st_nn</code> function accepts two layers, <code>x</code> and <code>y</code>, and returns a list with the same number of elements as <code>x</code> features. Each list element <code>i</code> is an integer vector with all indices <code>j</code> for which <code>x[i]</code> and <code>y[j]</code> are <strong>nearest neighbors</strong>.</p>
<p>For example, the following expression finds which feature in <code>towns</code> is the nearest neighbor to each feature in <code>cities</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nn</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_nn.html">st_nn</a></span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; lon-lat points</span>
<span class="va">nn</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 70</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 145</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 59</span></code></pre></div>
<p>This output tells us that <code>towns[70, ]</code> is the nearest among the 193 features of <code>towns</code> to <code>cities[1, ]</code>, <code>towns[145, ]</code> is the nearest to <code>cities[2, ]</code>, and <code>towns[59, ]</code> is the nearest to <code>cities[3, ]</code>.</p>
</div>
<div id="the-st_connect-function" class="section level2">
<h2 class="hasAnchor">
<a href="#the-st_connect-function" class="anchor"></a>The <code>st_connect</code> function</h2>
<p>The resulting nearest neighbor matches can be visualized using the <code>st_connect</code> function. This function builds a line layer connecting features from two layers <code>x</code> and <code>y</code> based on the relations defined in a list such the one returned by <code>st_nn</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_connect.html">st_connect</a></span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, ids <span class="op">=</span> <span class="va">nn</span><span class="op">)</span>
<span class="co">#&gt; Calculating nearest IDs</span>
<span class="co">#&gt; Calculating lines</span>
<span class="va">l</span>
<span class="co">#&gt; Geometry set for 3 features </span>
<span class="co">#&gt; Geometry type: LINESTRING</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 34.78177 ymin: 31.76832 xmax: 35.22 ymax: 32.82</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt; LINESTRING (35.21371 31.76832, 35.22 31.78)</span>
<span class="co">#&gt; LINESTRING (34.78177 32.0853, 34.8 32.08)</span>
<span class="co">#&gt; LINESTRING (34.98957 32.79405, 34.99 32.82)</span></code></pre></div>
<p>Plotting the line layer <code>l</code> gives a visual demonstration of the nearest neighbors match, as shown in Figure .</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">l</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">towns</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"darkgrey"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">cities</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">cities</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">cities</span><span class="op">)</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, col <span class="op">=</span> <span class="st">"red"</span>, pos <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="intro_files/figure-html/st_connect-1.png" alt="Nearest neighbor match between \texttt{cities} (in red) and \texttt{towns} (in grey)" width="50%"><p class="caption">
Nearest neighbor match between  (in red) and  (in grey)
</p>
</div>
</div>
<div id="dense-matrix-representation" class="section level2">
<h2 class="hasAnchor">
<a href="#dense-matrix-representation" class="anchor"></a>Dense matrix representation</h2>
<p>The <code>st_nn</code> can also return the complete logical matrix indicating whether each feature in <code>x</code> is a neighbor of <code>y</code>. To get the dense matrix, instead of a list, use <code>sparse=FALSE</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nn</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_nn.html">st_nn</a></span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span>, sparse <span class="op">=</span> <span class="cn">FALSE</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; lon-lat points</span>
<span class="va">nn</span>
<span class="co">#&gt;       [,1]  [,2]  [,3]  [,4]  [,5]</span>
<span class="co">#&gt; [1,] FALSE FALSE FALSE  TRUE FALSE</span>
<span class="co">#&gt; [2,] FALSE FALSE  TRUE FALSE FALSE</span>
<span class="co">#&gt; [3,] FALSE  TRUE FALSE FALSE FALSE</span></code></pre></div>
</div>
<div id="k-nearest-neighbors-where-k0" class="section level2">
<h2 class="hasAnchor">
<a href="#k-nearest-neighbors-where-k0" class="anchor"></a>k-Nearest neighbors where <code>k&gt;0</code>
</h2>
<p>It is also possible to return any <strong>k-nearest</strong> neighbors, rather than just one. For example, setting <code>k=2</code> returns both the 1<sup>st</sup> and 2<sup>nd</sup> nearest neighbors:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nn</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_nn.html">st_nn</a></span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, k <span class="op">=</span> <span class="fl">2</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; lon-lat points</span>
<span class="va">nn</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 70 99</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 145 175</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1]  59 179</span></code></pre></div>
<p>Here is another example, finding the 10-nearest neighbor <code>towns</code> features for each <code>cities</code> feature:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_nn.html">st_nn</a></span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, k <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt; lon-lat points</span>
<span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_connect.html">st_connect</a></span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, ids <span class="op">=</span> <span class="va">x</span><span class="op">)</span></code></pre></div>
<p>The result is visualized in Figure .</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">l</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">cities</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">towns</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"darkgrey"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="intro_files/figure-html/cities_towns-1.png" alt="Nearest 10 \texttt{towns} features from each \texttt{cities} feature" width="50%"><p class="caption">
Nearest 10  features from each  feature
</p>
</div>
</div>
<div id="distance-to-nearest-neighbors" class="section level2">
<h2 class="hasAnchor">
<a href="#distance-to-nearest-neighbors" class="anchor"></a>Distance to nearest neighbors</h2>
<p>Using <code>returnDist=TRUE</code> the distances <code>list</code> is also returned, in addition the the neighbor matches, with both components now comprising a <code>list</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nn</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_nn.html">st_nn</a></span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, k <span class="op">=</span> <span class="fl">1</span>, returnDist <span class="op">=</span> <span class="cn">TRUE</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; lon-lat points</span>
<span class="va">nn</span>
<span class="co">#&gt; $nn</span>
<span class="co">#&gt; $nn[[1]]</span>
<span class="co">#&gt; [1] 70</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $nn[[2]]</span>
<span class="co">#&gt; [1] 145</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $nn[[3]]</span>
<span class="co">#&gt; [1] 59</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $dist</span>
<span class="co">#&gt; $dist[[1]]</span>
<span class="co">#&gt; [1] 1425.692</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $dist[[2]]</span>
<span class="co">#&gt; [1] 1818.853</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $dist[[3]]</span>
<span class="co">#&gt; [1] 2878.572</span></code></pre></div>
</div>
<div id="search-radius" class="section level2">
<h2 class="hasAnchor">
<a href="#search-radius" class="anchor"></a>Search radius</h2>
<p>Finally, the search for nearest neighbors can be limited to a <strong>search radius</strong> using <code>maxdist</code>. In the following example, the search radius is set to 2,000 meters (2 kilometers). Note that no neighbors are found within the search radius for <code>cities[3, ]</code>, therefore the third lest element is a zero-length vector of indices:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nn</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_nn.html">st_nn</a></span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, k <span class="op">=</span> <span class="fl">1</span>, maxdist <span class="op">=</span> <span class="fl">2000</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; lon-lat points</span>
<span class="va">nn</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 70</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 145</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; integer(0)</span></code></pre></div>
</div>
<div id="spatial-join" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-join" class="anchor"></a>Spatial join</h2>
<p>The <code>st_nn</code> function can also be used as a <strong>predicate function</strong> when performing spatial join with <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join</a></code>. For example, the following expression spatially joins the two nearest <code>towns</code> features to each <code>cities</code> features, using a search radius of 5 km:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">st_join</span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, join <span class="op">=</span> <span class="va">st_nn</span>, k <span class="op">=</span> <span class="fl">2</span>, maxdist <span class="op">=</span> <span class="fl">5000</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; lon-lat points</span>
<span class="co">#&gt; Simple feature collection with 5 features and 5 fields</span>
<span class="co">#&gt; Geometry type: POINT</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 34.78177 ymin: 31.76832 xmax: 35.21371 ymax: 32.79405</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt;        name.x        name.y country.etc    pop capital</span>
<span class="co">#&gt; 1   Jerusalem     Jerusalem      Israel 731731       1</span>
<span class="co">#&gt; 2    Tel-Aviv     Ramat Gan      Israel 128583       0</span>
<span class="co">#&gt; 2.1  Tel-Aviv Tel Aviv-Yafo      Israel 384276       0</span>
<span class="co">#&gt; 3       Haifa         Haifa      Israel 266418       0</span>
<span class="co">#&gt; 3.1     Haifa  Tirat Karmel      Israel  19080       0</span>
<span class="co">#&gt;                      geometry</span>
<span class="co">#&gt; 1   POINT (35.21371 31.76832)</span>
<span class="co">#&gt; 2    POINT (34.78177 32.0853)</span>
<span class="co">#&gt; 2.1  POINT (34.78177 32.0853)</span>
<span class="co">#&gt; 3   POINT (34.98957 32.79405)</span>
<span class="co">#&gt; 3.1 POINT (34.98957 32.79405)</span></code></pre></div>
</div>
<div id="binding-distances-to-join-result" class="section level2">
<h2 class="hasAnchor">
<a href="#binding-distances-to-join-result" class="anchor"></a>Binding distances to join result</h2>
<p>Sometimes it’s necessary to bind the distances to the joined features in the resulting layer, to have more detailed information about the distance to nearest features. For example, suppose we join the nearest <code>towns</code> feature to <code>cities</code>, as shown above:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cities1</span> <span class="op">=</span> <span class="fu">st_join</span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, join <span class="op">=</span> <span class="va">st_nn</span>, k <span class="op">=</span> <span class="fl">1</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; lon-lat points</span>
<span class="va">cities1</span>
<span class="co">#&gt; Simple feature collection with 3 features and 5 fields</span>
<span class="co">#&gt; Geometry type: POINT</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 34.78177 ymin: 31.76832 xmax: 35.21371 ymax: 32.79405</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt;      name.x    name.y country.etc    pop capital                  geometry</span>
<span class="co">#&gt; 1 Jerusalem Jerusalem      Israel 731731       1 POINT (35.21371 31.76832)</span>
<span class="co">#&gt; 2  Tel-Aviv Ramat Gan      Israel 128583       0  POINT (34.78177 32.0853)</span>
<span class="co">#&gt; 3     Haifa     Haifa      Israel 266418       0 POINT (34.98957 32.79405)</span></code></pre></div>
<p>As shown above, the distances can be calculated using the <code>returnDist=TRUE</code> option, then binded to the above join result:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Calculate distances</span>
<span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_nn.html">st_nn</a></span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, k <span class="op">=</span> <span class="fl">1</span>, returnDist <span class="op">=</span> <span class="cn">TRUE</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; lon-lat points</span>
<span class="va">dists</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="st">"["</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">dists</span>
<span class="co">#&gt; [1] 1425.692 1818.853 2878.572</span>

<span class="co"># Bind distances</span>
<span class="va">cities1</span><span class="op">$</span><span class="va">dist</span> <span class="op">=</span> <span class="va">dists</span>
<span class="va">cities1</span>
<span class="co">#&gt; Simple feature collection with 3 features and 6 fields</span>
<span class="co">#&gt; Geometry type: POINT</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 34.78177 ymin: 31.76832 xmax: 35.21371 ymax: 32.79405</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt;      name.x    name.y country.etc    pop capital                  geometry</span>
<span class="co">#&gt; 1 Jerusalem Jerusalem      Israel 731731       1 POINT (35.21371 31.76832)</span>
<span class="co">#&gt; 2  Tel-Aviv Ramat Gan      Israel 128583       0  POINT (34.78177 32.0853)</span>
<span class="co">#&gt; 3     Haifa     Haifa      Israel 266418       0 POINT (34.98957 32.79405)</span>
<span class="co">#&gt;       dist</span>
<span class="co">#&gt; 1 1425.692</span>
<span class="co">#&gt; 2 1818.853</span>
<span class="co">#&gt; 3 2878.572</span></code></pre></div>
<p>In the above workflow, we actually ran the same nearest neighbor search <em>twice</em>, once in <code>st_join</code> and more time to get the distances.</p>
<p>Another more verbose approach can be used in case the computation time is prohibitive. Here, we calculate the nearest neighbor indices and distances just once, then use them to construct the “joined” table with the distances:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get indices &amp; distances</span>
<span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_nn.html">st_nn</a></span><span class="op">(</span><span class="va">cities</span>, <span class="va">towns</span>, k <span class="op">=</span> <span class="fl">1</span>, returnDist <span class="op">=</span> <span class="cn">TRUE</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; lon-lat points</span>
<span class="va">ids</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">"["</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">dists</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="st">"["</span>, <span class="fl">1</span><span class="op">)</span>

<span class="co"># Join</span>
<span class="va">cities1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">cities</span>, <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="va">towns</span><span class="op">)</span><span class="op">[</span><span class="va">ids</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>
<span class="va">cities1</span> <span class="op">=</span> <span class="fu">st_sf</span><span class="op">(</span><span class="va">cities1</span><span class="op">)</span>

<span class="co"># Add distances</span>
<span class="va">cities1</span><span class="op">$</span><span class="va">dist</span> <span class="op">=</span> <span class="va">dists</span>
<span class="va">cities1</span>
<span class="co">#&gt; Simple feature collection with 3 features and 6 fields</span>
<span class="co">#&gt; Geometry type: POINT</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 34.78177 ymin: 31.76832 xmax: 35.21371 ymax: 32.79405</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt;        name    name.1 country.etc    pop capital                  geometry</span>
<span class="co">#&gt; 1 Jerusalem Jerusalem      Israel 731731       1 POINT (35.21371 31.76832)</span>
<span class="co">#&gt; 2  Tel-Aviv Ramat Gan      Israel 128583       0  POINT (34.78177 32.0853)</span>
<span class="co">#&gt; 3     Haifa     Haifa      Israel 266418       0 POINT (34.98957 32.79405)</span>
<span class="co">#&gt;       dist</span>
<span class="co">#&gt; 1 1425.692</span>
<span class="co">#&gt; 2 1818.853</span>
<span class="co">#&gt; 3 2878.572</span></code></pre></div>
</div>
<div id="polygons" class="section level2">
<h2 class="hasAnchor">
<a href="#polygons" class="anchor"></a>Polygons</h2>
<p>Nearest neighbor search also works for non-point layers. The following code section finds the 20-nearest <code>towns</code> features for each water body in <code>water[-1, ]</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nn</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_nn.html">st_nn</a></span><span class="op">(</span><span class="va">water</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">towns</span>, k <span class="op">=</span> <span class="fl">20</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; lines or polygons</span></code></pre></div>
<p>Again, we can calculate the respective lines for the above result using <code>st_connect</code>. Since one of the inputs is line/polygon, we need to specify a sampling distance <code>dist</code>, which sets the resolution of connecting points on the shape exterior boundary.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_connect.html">st_connect</a></span><span class="op">(</span><span class="va">water</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">towns</span>, ids <span class="op">=</span> <span class="va">nn</span>, dist <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="co">#&gt; Calculating nearest IDs</span>
<span class="co">#&gt; Calculating lines</span></code></pre></div>
<p>The result is visualized in Figure .</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">water</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"lightblue"</span>, border <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">towns</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"darkgrey"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">l</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="intro_files/figure-html/water_towns-1.png" alt="Nearest 20 \texttt{towns} features from each \texttt{water} polygon" width="50%"><p class="caption">
Nearest 20  features from each  polygon
</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Michael Dorman.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
